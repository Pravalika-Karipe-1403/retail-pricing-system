#################### COUNTRY ##########################################
CREATE TABLE country (
    country_id BIGINT PRIMARY KEY,
    country_code VARCHAR(10) NOT NULL,
    country_name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_at TIMESTAMP,
    updated_by VARCHAR(100),
    CONSTRAINT uq_country_code UNIQUE (country_code),
    CONSTRAINT uq_country_name UNIQUE (country_name)
);
-- INDEX for dropdown search
CREATE INDEX idx_country_name
ON country(country_name);


#################### CITY ##########################################
CREATE TABLE city (
    city_id BIGINT PRIMARY KEY,
    city_name VARCHAR(100) NOT NULL,
    country_id BIGINT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_at TIMESTAMP,
    updated_by VARCHAR(100),
    CONSTRAINT fk_city_country
        FOREIGN KEY (country_id)
        REFERENCES country(country_id),

    CONSTRAINT uq_city_country
        UNIQUE (city_name, country_id)

);

-- MOST IMPORTANT INDEX (for filtering cities by country)
CREATE INDEX idx_city_country_id
ON city(country_id);

-- INDEX for search
CREATE INDEX idx_city_name
ON city(city_name);

#################### STORE ##########################################
CREATE TABLE store (
    store_id BIGINT PRIMARY KEY,
    store_code VARCHAR(50) NOT NULL,
    store_name VARCHAR(150) NOT NULL,
    city_id BIGINT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_by VARCHAR(100),
    updated_at TIMESTAMP,
    updated_by VARCHAR(100),
    CONSTRAINT fk_store_city
        FOREIGN KEY (city_id)
        REFERENCES city(city_id),
    CONSTRAINT uq_store_code UNIQUE (store_code)
);

-- MOST IMPORTANT INDEX
CREATE INDEX idx_store_city_id
ON store(city_id);

-- INDEX for dropdown
CREATE INDEX idx_store_name
ON store(store_name);
-- INDEX for code search
CREATE INDEX idx_store_code
ON store(store_code);

#################### PRODUCT ##########################################
CREATE TABLE retail.product (
    product_id INT NOT NULL AUTO_INCREMENT,
    sku VARCHAR(50) NOT NULL UNIQUE,
    product_name VARCHAR(255) NOT NULL, 
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (product_id)
);

-- Indexes
CREATE INDEX idx_product_name ON retail.product(product_name);
CREATE FULLTEXT INDEX idx_product_name_ft ON retail.product(product_name);


#################### PRICING ##########################################
CREATE TABLE retail.pricing (
    pricing_id BIGINT NOT NULL AUTO_INCREMENT,
    product_id INT NOT NULL,       
    store_id BIGINT NOT NULL,         
    price DECIMAL(10,2) NOT NULL,
    effective_date DATE NOT NULL,
    batch_id VARCHAR(50),
    created_by VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(50),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (pricing_id),
    CONSTRAINT fk_pricing_product FOREIGN KEY (product_id) REFERENCES retail.product(product_id) ON DELETE CASCADE,
    CONSTRAINT fk_pricing_store FOREIGN KEY (store_id) REFERENCES retail.store(store_id) ON DELETE CASCADE
);

CREATE INDEX idx_pricing_product_effective ON retail.pricing(product_id, store_id, effective_date);
CREATE INDEX idx_pricing_batch ON retail.pricing(batch_id);
CREATE INDEX idx_pricing_latest ON retail.pricing(store_id, product_id, effective_date DESC);


ALTER TABLE retail.pricing
ADD COLUMN is_active BOOLEAN NOT NULL DEFAULT TRUE
AFTER effective_date;

CREATE INDEX idx_pricing_active_latest
ON retail.pricing (store_id, product_id, is_active, effective_date DESC);